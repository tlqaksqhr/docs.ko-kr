---
title: '방법: 스레드 로컬 변수를 사용하는 Parallel.ForEach 루프 작성'
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- parallel foreach loop, how to use local state
ms.assetid: 24b10041-b30b-45cb-aa65-66cf568ca76d
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: 4a89b3f25fb3d6e85c666e57f24e68c297c8c29a
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: HT
ms.contentlocale: ko-KR
ms.lasthandoff: 05/04/2018
---
# <a name="how-to-write-a-parallelforeach-loop-with-thread-local-variables"></a><span data-ttu-id="55f07-102">방법: 스레드 로컬 변수를 사용하는 Parallel.ForEach 루프 작성</span><span class="sxs-lookup"><span data-stu-id="55f07-102">How to: Write a Parallel.ForEach Loop with Thread-Local Variables</span></span>
<span data-ttu-id="55f07-103">다음 예제에서는 스레드 지역 변수를 사용하는 <xref:System.Threading.Tasks.Parallel.ForEach%2A> 메서드를 작성하는 방법을 보여 줍니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-103">The following example shows how to write a <xref:System.Threading.Tasks.Parallel.ForEach%2A> method that uses thread-local variables.</span></span> <span data-ttu-id="55f07-104"><xref:System.Threading.Tasks.Parallel.ForEach%2A> 루프가 실행되면 해당 소스 컬렉션이 여러 파티션으로 나뉩니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-104">When a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop executes, it divides its source collection into multiple partitions.</span></span> <span data-ttu-id="55f07-105">각 파티션은 "스레드 지역" 변수의 자체 복사본을 갖게 됩니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-105">Each partition will get its own copy of the "thread-local" variable.</span></span> <span data-ttu-id="55f07-106">(여기서 "스레드 지역"이라는 용어는 다소 부정확합니다. 일부 경우 두 개의 파티션이 동일한 스레드에서 실행될 수 있기 때문입니다.)</span><span class="sxs-lookup"><span data-stu-id="55f07-106">(The term "thread-local" is slightly inaccurate here, because in some cases two partitions may run on the same thread.)</span></span>  
  
 <span data-ttu-id="55f07-107">이 예제의 코드와 매개 변수는 해당 <xref:System.Threading.Tasks.Parallel.For%2A> 메서드와 매우 흡사합니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-107">The code and parameters in this example closely resemble the corresponding <xref:System.Threading.Tasks.Parallel.For%2A> method.</span></span> <span data-ttu-id="55f07-108">자세한 내용은 [방법: 스레드 로컬 변수를 사용하는 Parallel.For 루프 작성](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)을 참조하세요.</span><span class="sxs-lookup"><span data-stu-id="55f07-108">For more information, see [How to: Write a Parallel.For Loop with Thread-Local Variables](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md).</span></span>  
  
 <span data-ttu-id="55f07-109"><xref:System.Threading.Tasks.Parallel.ForEach%2A> 루프에 스레드 지역 변수를 사용하려면 두 가지 형식의 매개 변수를 사용하는 메서드 오버로드 중 하나를 호출해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-109">To use a thread-local variable in a <xref:System.Threading.Tasks.Parallel.ForEach%2A> loop, you must call one of the method overloads that takes two type parameters.</span></span> <span data-ttu-id="55f07-110">첫 번째 형식 매개 변수인 `TSource`는 소스 요소의 형식을 지정하고, 두 번째 형식 매개 변수인 `TLocal`은 스레드 지역 변수의 형식을 지정합니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-110">The first type parameter, `TSource`, specifies the type of the source element, and the second type parameter, `TLocal`, specifies the type of the thread-local variable.</span></span>  
  
## <a name="example"></a><span data-ttu-id="55f07-111">예</span><span class="sxs-lookup"><span data-stu-id="55f07-111">Example</span></span>  
 <span data-ttu-id="55f07-112">다음 예제에서는 <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> 오버로드를 호출하여 1백만 개의 요소가 포함된 배열의 합계를 계산합니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-112">The following example calls <xref:System.Threading.Tasks.Parallel.ForEach%60%602%28System.Collections.Generic.IEnumerable%7B%60%600%7D%2CSystem.Func%7B%60%601%7D%2CSystem.Func%7B%60%600%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%601%2C%60%601%7D%2CSystem.Action%7B%60%601%7D%29?displayProperty=nameWithType> overload to compute the sum of an array of one million elements.</span></span> <span data-ttu-id="55f07-113">이 오버로드에는 다음과 같은 4개의 매개 변수가 있습니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-113">This overload has four parameters:</span></span>  
  
-   <span data-ttu-id="55f07-114">`source`: 데이터 소스이며,</span><span class="sxs-lookup"><span data-stu-id="55f07-114">`source`, which is the data source.</span></span> <span data-ttu-id="55f07-115"><xref:System.Collections.Generic.IEnumerable%601>를 구현해야 합니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-115">It must implement <xref:System.Collections.Generic.IEnumerable%601>.</span></span> <span data-ttu-id="55f07-116">이 예제에서 데이터 소스는 `IEnumerable<Int32>` 메서드에서 반환된 1백만 개의 멤버 <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> 개체입니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-116">The data source in our example is the one million member `IEnumerable<Int32>` object returned by the <xref:System.Linq.Enumerable.Range%2A?displayProperty=nameWithType> method.</span></span>  
  
-   <span data-ttu-id="55f07-117">`localInit` 또는 스레드 지역 변수를 초기화하는 함수입니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-117">`localInit`, or the function that initializes the thread-local variable.</span></span> <span data-ttu-id="55f07-118">이 함수는 <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> 작업이 실행되는 각 파티션에 대해 한 번 호출됩니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-118">This function is called once for each partition in which the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> operation executes.</span></span> <span data-ttu-id="55f07-119">이 예제에서는 스레드 지역 변수를 0으로 초기화합니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-119">Our example initializes the thread-local variable to zero.</span></span>  
  
-   <span data-ttu-id="55f07-120">`body`: 루프가 반복될 때마다 병렬 루프에 의해 호출되는 <xref:System.Func%604>입니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-120">`body`, a <xref:System.Func%604> that is invoked by the parallel loop on each iteration of the loop.</span></span> <span data-ttu-id="55f07-121">해당 시그니처는 `Func\<TSource, ParallelLoopState, TLocal, TLocal>`입니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-121">Its signature is `Func\<TSource, ParallelLoopState, TLocal, TLocal>`.</span></span> <span data-ttu-id="55f07-122">사용자는 대리자의 코드를 제공하고, 루프는 다음과 같은 입력 매개 변수를 전달합니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-122">You supply the code for the delegate, and the loop passes in the input parameters, which are:</span></span>  
  
    -   <span data-ttu-id="55f07-123"><xref:System.Collections.Generic.IEnumerable%601>의 현재 요소</span><span class="sxs-lookup"><span data-stu-id="55f07-123">The current element of the <xref:System.Collections.Generic.IEnumerable%601>.</span></span>  
  
    -   <span data-ttu-id="55f07-124">루프의 상태를 검토하기 위해 대리자 코드에 사용할 수 있는 <xref:System.Threading.Tasks.ParallelLoopState> 변수</span><span class="sxs-lookup"><span data-stu-id="55f07-124">A <xref:System.Threading.Tasks.ParallelLoopState> variable that you can use in your delegate's code to examine the state of the loop.</span></span>  
  
    -   <span data-ttu-id="55f07-125">스레드 지역 변수</span><span class="sxs-lookup"><span data-stu-id="55f07-125">The thread-local variable.</span></span>  
  
     <span data-ttu-id="55f07-126">대리자는 스레드 지역 변수를 반환하고, 그런 다음 스레드 지역 변수는 해당 특정 파티션에서 실행되는 루프의 다음 반복으로 전달됩니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-126">Your delegate returns the thread-local variable, which is then passed to the next iteration of the loop that executes in that particular partition.</span></span> <span data-ttu-id="55f07-127">각 루프 파티션에서는 이 변수의 별도의 인스턴스를 유지합니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-127">Each loop partition maintains a separate instance of this variable.</span></span>  
  
     <span data-ttu-id="55f07-128">이 예제에서는 대리자가 각 정수 값을 스레드 지역 변수에 더하고, 스레드 지역 변수는 해당 파티션에서 정수 요소 값의 누계를 유지합니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-128">In the example, the delegate adds the value of each integer to the thread-local variable, which maintains a running total of the values of the integer elements in that partition.</span></span>  
  
-   <span data-ttu-id="55f07-129">`localFinally`: 각 파티션의 루프 작업이 완료될 때 `Action<TLocal>`가 호출하는 <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> 대리자입니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-129">`localFinally`, an `Action<TLocal>` delegate that the <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> invokes when the looping operations in each partition have completed.</span></span> <span data-ttu-id="55f07-130"><xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> 메서드는 이 스레드(또는 루프 파티션)에 대한 스레드 지역 변수의 최종 값을 `Action<TLocal>` 대리자에게 전달하고, 사용자는 이 파티션의 결과를 다른 파티션의 결과와 결합하는 데 필요한 작업을 수행하는 코드를 제공합니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-130">The <xref:System.Threading.Tasks.Parallel.ForEach%2A?displayProperty=nameWithType> method passes your `Action<TLocal>` delegate the final value of the thread-local variable for this thread (or loop partition), and you provide the code that performs the required action for combining the result from this partition with the results from the other partitions.</span></span> <span data-ttu-id="55f07-131">이 대리자는 여러 작업에서 동시에 호출할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-131">This delegate can be invoked concurrently by multiple tasks.</span></span> <span data-ttu-id="55f07-132">그렇기 때문에 이 예제에서는 <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> 메서드를 사용하여 `total` 변수에 대한 액세스를 동기화합니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-132">Because of this, the example uses the <xref:System.Threading.Interlocked.Add%28System.Int32%40%2CSystem.Int32%29?displayProperty=nameWithType> method to synchronize access to the `total` variable.</span></span> <span data-ttu-id="55f07-133">대리자 형식이 <xref:System.Action%601>이므로 반환 값은 없습니다.</span><span class="sxs-lookup"><span data-stu-id="55f07-133">Because the delegate type is an <xref:System.Action%601>, there is no return value.</span></span>  
  
 [!code-csharp[TPL_Parallel#04](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/foreachthreadlocal.cs#04)]
 [!code-vb[TPL_Parallel#04](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/foreachthreadlocal.vb#04)]  
  
## <a name="see-also"></a><span data-ttu-id="55f07-134">참고 항목</span><span class="sxs-lookup"><span data-stu-id="55f07-134">See Also</span></span>  
 [<span data-ttu-id="55f07-135">데이터 병렬 처리</span><span class="sxs-lookup"><span data-stu-id="55f07-135">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
 [<span data-ttu-id="55f07-136">방법: 스레드 로컬 변수를 사용하는 Parallel.For 루프 작성</span><span class="sxs-lookup"><span data-stu-id="55f07-136">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>](../../../docs/standard/parallel-programming/how-to-write-a-parallel-for-loop-with-thread-local-variables.md)  
 [<span data-ttu-id="55f07-137">PLINQ 및 TPL의 람다 식</span><span class="sxs-lookup"><span data-stu-id="55f07-137">Lambda Expressions in PLINQ and TPL</span></span>](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)
