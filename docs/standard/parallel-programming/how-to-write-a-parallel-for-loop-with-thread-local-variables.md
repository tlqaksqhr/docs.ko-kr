---
title: "방법: 스레드 로컬 변수를 사용하는 Parallel.For 루프 작성"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-standard
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords: parallel for loops, how to use local state
ms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb
caps.latest.revision: "23"
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.openlocfilehash: 2e0b3e28c95d9ccfb0ecd1954e16960576d8f115
ms.sourcegitcommit: 4f3fef493080a43e70e951223894768d36ce430a
ms.translationtype: HT
ms.contentlocale: ko-KR
ms.lasthandoff: 11/21/2017
---
# <a name="how-to-write-a-parallelfor-loop-with-thread-local-variables"></a><span data-ttu-id="d6d49-102">방법: 스레드 로컬 변수를 사용하는 Parallel.For 루프 작성</span><span class="sxs-lookup"><span data-stu-id="d6d49-102">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>
<span data-ttu-id="d6d49-103">이 예제에서는 스레드 지역 변수를 사용하여, <xref:System.Threading.Tasks.Parallel.For%2A> 루프에 의해 만들어진 각 별도 작업의 상태를 저장하고 검색하는 방법을 보여 줍니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-103">This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop.</span></span> <span data-ttu-id="d6d49-104">스레드 지역 데이터를 사용하여, 공유 상태에 대한 많은 수의 액세스를 동기화하는 오버헤드를 방지할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-104">By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state.</span></span> <span data-ttu-id="d6d49-105">반복할 때마다 공유 리소스에 쓰는 대신 작업의 반복이 모두 완료될 때까지 값을 계산하여 저장합니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-105">Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete.</span></span> <span data-ttu-id="d6d49-106">그런 다음 공유 리소스에 최종 결과를 한 번 쓰거나, 최종 결과를 다른 메서드로 전달할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-106">You can then write the final result once to the shared resource, or pass it to another method.</span></span>  
  
## <a name="example"></a><span data-ttu-id="d6d49-107">예제</span><span class="sxs-lookup"><span data-stu-id="d6d49-107">Example</span></span>  
 <span data-ttu-id="d6d49-108">다음 예제에서는 <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> 메서드를 호출하여 1백만 개의 요소가 포함된 배열의 값 합계를 계산합니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-108">The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements.</span></span> <span data-ttu-id="d6d49-109">각 요소의 값은 해당 인덱스와 같습니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-109">The value of each element is equal to its index.</span></span>  
  
 [!code-csharp[TPL_Parallel#05](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/forandforeach_simple.cs#05)]
 [!code-vb[TPL_Parallel#05](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/forwiththreadlocal.vb#05)]  
  
 <span data-ttu-id="d6d49-110">모든 <xref:System.Threading.Tasks.Parallel.For%2A> 메서드의 처음 두 매개 변수는 시작 및 끝 반복 값을 지정합니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-110">The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values.</span></span> <span data-ttu-id="d6d49-111">메서드의 이 오버로드에서 세 번째 매개 변수는 로컬 상태를 초기화하는 위치입니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-111">In this overload of the method, the third parameter is where you initialize your local state.</span></span> <span data-ttu-id="d6d49-112">이 컨텍스트에서 로컬 상태는 수명이 현재 스레드에 대한 루프의 첫 번째 반복 바로 전에서 마지막 반복 바로 후까지 연장되는 변수를 의미합니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-112">In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.</span></span>  
  
 <span data-ttu-id="d6d49-113">세 번째 매개 변수의 형식은 <xref:System.Func%601>이며, 여기서 `TResult`는 스레드 지역 변수를 저장하는 변수의 형식입니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-113">The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state.</span></span> <span data-ttu-id="d6d49-114">해당 형식은 제네릭 <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> 메서드를 호출할 때 제공되는 제네릭 형식 인수에 의해 정의되며, 이 경우 <xref:System.Int64>입니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-114">Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>.</span></span> <span data-ttu-id="d6d49-115">형식 인수는 컴파일러에 스레드 지역 상태를 저장하는 데 사용되는 임시 변수의 형식을 알립니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-115">The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state.</span></span> <span data-ttu-id="d6d49-116">이 예제에서 `() => 0`(또는 Visual Basic의 경우 `Function() 0`) 식은 스레드 지역 변수를 0으로 초기화합니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-116">In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero.</span></span> <span data-ttu-id="d6d49-117">제네릭 형식 인수가 참조 형식 또는 사용자 정의 값 형식인 경우 식은 다음과 같습니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-117">If the generic type argument is a reference type or user-defined value type, the expression would look like this:</span></span>  
  
```csharp  
() => new MyClass()  
```  
  
```vb  
Function() new MyClass()  
```  
  
 <span data-ttu-id="d6d49-118">네 번째 매개 변수는 루프 논리를 정의합니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-118">The fourth parameter defines the loop logic.</span></span> <span data-ttu-id="d6d49-119">이 매개 변수는 시그니처가 `Func<int, ParallelLoopState, long, long>`(C#의 경우) 또는 `Func(Of Integer, ParallelLoopState, Long, Long)`(Visual Basic의 경우)인 대리자 또는 람다 식이어야 합니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-119">It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic.</span></span> <span data-ttu-id="d6d49-120">첫 번째 매개 변수는 루프의 해당 반복에 대한 루프 카운터의 값입니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-120">The first parameter is the value of the loop counter for that iteration of the loop.</span></span> <span data-ttu-id="d6d49-121">두 번째 매개 변수는 루프를 중단하는 데 사용할 수 있는 <xref:System.Threading.Tasks.ParallelLoopState> 개체입니다. 이 개체는 <xref:System.Threading.Tasks.Parallel> 클래스에 의해 루프의 각 발생으로 제공됩니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-121">The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop.</span></span> <span data-ttu-id="d6d49-122">세 번째 매개 변수는 스레드 지역 변수입니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-122">The third parameter is the thread-local variable.</span></span> <span data-ttu-id="d6d49-123">마지막 매개 변수는 반환 형식입니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-123">The last parameter is the return type.</span></span> <span data-ttu-id="d6d49-124">이 경우 반환 형식은 <xref:System.Int64>입니다. 이 형식이 사용자가 <xref:System.Threading.Tasks.Parallel.For%2A> 형식 인수에 지정한 형식이기 때문입니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-124">In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument.</span></span> <span data-ttu-id="d6d49-125">해당 변수의 이름은 `subtotal`로 지정되며 람다 식에 의해 반환됩니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-125">That variable is named `subtotal` and is returned by the lambda expression.</span></span> <span data-ttu-id="d6d49-126">반환 값은 이후에 루프가 반복될 때마다 `subtotal`을 초기화하는 데 사용됩니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-126">The return value is used to initialize `subtotal` on each subsequent iteration of the loop.</span></span> <span data-ttu-id="d6d49-127">또한 이 마지막 매개 변수를 각 반복에 전달된 다음 마지막 반복이 완료될 때 `localFinally` 대리자에게 전달되는 값으로 생각할 수 있습니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-127">You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete.</span></span>  
  
 <span data-ttu-id="d6d49-128">다섯 번째 매개 변수는 특정 스레드에 대한 모든 반복이 완료된 후 한 번 호출되는 메서드를 정의합니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-128">The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed.</span></span> <span data-ttu-id="d6d49-129">입력 인수의 형식은 다시 <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> 메서드의 형식 인수 및 본문 람다 식에 의해 반환되는 형식에 해당합니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-129">The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression.</span></span> <span data-ttu-id="d6d49-130">이 예제에서 값은 <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> 메서드를 호출하여 스레드로부터 안전한 방법으로 클래스 범위에서 변수에 더해집니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-130">In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="d6d49-131">스레드 지역 변수를 사용하여, 루프가 반복될 때마다 이 클래스 변수에 쓰는 것을 방지했습니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-131">By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.</span></span>  
  
 <span data-ttu-id="d6d49-132">람다 식을 사용 하는 방법에 대 한 자세한 내용은 참조 [PLINQ 및 TPL의 람다 식](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)합니다.</span><span class="sxs-lookup"><span data-stu-id="d6d49-132">For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d6d49-133">참고 항목</span><span class="sxs-lookup"><span data-stu-id="d6d49-133">See Also</span></span>  
 [<span data-ttu-id="d6d49-134">데이터 병렬 처리</span><span class="sxs-lookup"><span data-stu-id="d6d49-134">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
 [<span data-ttu-id="d6d49-135">병렬 프로그래밍</span><span class="sxs-lookup"><span data-stu-id="d6d49-135">Parallel Programming</span></span>](../../../docs/standard/parallel-programming/index.md)  
 [<span data-ttu-id="d6d49-136">TPL(작업 병렬 라이브러리)</span><span class="sxs-lookup"><span data-stu-id="d6d49-136">Task Parallel Library (TPL)</span></span>](../../../docs/standard/parallel-programming/task-parallel-library-tpl.md)  
 [<span data-ttu-id="d6d49-137">PLINQ 및 TPL의 람다 식</span><span class="sxs-lookup"><span data-stu-id="d6d49-137">Lambda Expressions in PLINQ and TPL</span></span>](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)
